# คู่มือการย้ายระบบ (จาก v2 ไปยัง v3)

## สรุปย่อ

- V3 นำเสนอการควบคุมสิทธิ์แบบละเอียดและฟังก์ชันร้านค้าบอท ซึ่งต้องการการเปลี่ยนแปลงสคีมา DynamoDB
- **สำรองข้อมูลตาราง ConversationTable ของ DynamoDB ก่อนการย้ายข้อมูล**
- อัปเดต URL ของคลังข้อมูลจาก `bedrock-claude-chat` เป็น `bedrock-chat`
- เรียกใช้สคริปต์การย้ายข้อมูลเพื่อแปลงข้อมูลเป็นสคีมาใหม่
- บอทและการสนทนาทั้งหมดของคุณจะถูกเก็บรักษาด้วยโมเดลสิทธิ์ใหม่
- **สำคัญ: ระหว่างกระบวนการย้ายข้อมูล แอปพลิเคชันจะไม่สามารถใช้งานได้สำหรับผู้ใช้ทั้งหมดจนกว่าการย้ายข้อมูลจะเสร็จสิ้น กระบวนการนี้ใช้เวลาประมาณ 60 นาที ขึ้นอยู่กับปริมาณข้อมูลและประสิทธิภาพของสภาพแวดล้อมการพัฒนาของคุณ**
- **สำคัญ: API ที่เผยแพร่ทั้งหมดต้องถูกลบระหว่างกระบวนการย้ายข้อมูล**
- **คำเตือน: กระบวนการย้ายข้อมูลไม่สามารถรับประกันความสำเร็จ 100% สำหรับบอททั้งหมด กรุณาบันทึกการตั้งค่าบอทที่สำคัญก่อนการย้ายข้อมูลในกรณีที่คุณต้องสร้างใหม่ด้วยตนเอง**

## บทนำ

### มีอะไรใหม่ใน V3

V3 นำการปรับปรุงที่สำคัญมาสู่ Bedrock Chat:

1. **การควบคุมสิทธิ์แบบละเอียด**: ควบคุมการเข้าถึงบอทของคุณด้วยสิทธิ์ตามกลุ่มผู้ใช้
2. **Bot Store**: แบ่งปันและค้นพบบอทผ่านตลาดกลาง
3. **คุณสมบัติการดูแลระบบ**: จัดการ API, ทำเครื่องหมายบอทเป็นสำคัญ และวิเคราะห์การใช้งานบอท

คุณสมบัติใหม่เหล่านี้ต้องการการเปลี่ยนแปลงในสคีมา DynamoDB ซึ่งจำเป็นต้องมีกระบวนการย้ายข้อมูลสำหรับผู้ใช้ที่มีอยู่

### ทำไมต้องย้ายข้อมูลนี้

แบบจำลองสิทธิ์ใหม่และฟังก์ชัน Bot Store จำเป็นต้องปรับโครงสร้างวิธีการจัดเก็บและเข้าถึงข้อมูลบอท กระบวนการย้ายข้อมูลจะแปลงบอทและการสนทนาที่มีอยู่ของคุณไปยังสคีมาใหม่โดยคงข้อมูลทั้งหมดไว้

> [!WARNING]
> ประกาศการหยุดให้บริการ: **ระหว่างกระบวนการย้ายข้อมูล แอปพลิเคชันจะไม่พร้อมใช้งานสำหรับผู้ใช้ทั้งหมด** วางแผนดำเนินการย้ายข้อมูลนี้ในช่วงเวลาบำรุงรักษาเมื่อผู้ใช้ไม่จำเป็นต้องเข้าถึงระบบ แอปพลิเคชันจะกลับมาพร้อมใช้งานอีกครั้งหลังจากสคริปต์ย้ายข้อมูลดำเนินการสำเร็จและแปลงข้อมูลทั้งหมดเป็นสคีมาใหม่ กระบวนการนี้ใช้เวลาประมาณ 60 นาที ขึ้นอยู่กับปริมาณข้อมูลและประสิทธิภาพของสภาพแวดล้อมการพัฒนาของคุณ

> [!IMPORTANT]
> ก่อนดำเนินการย้ายข้อมูล: **กระบวนการย้ายข้อมูลไม่สามารถรับประกันความสำเร็จ 100% สำหรับบอททั้งหมด** โดยเฉพาะอย่างยิ่งบอทที่สร้างด้วยเวอร์ชันเก่าหรือมีการกำหนดค่าแบบกำหนดเอง กรุณาจดบันทึกการกำหนดค่าบอทที่สำคัญ (คำแนะนำ แหล่งความรู้ การตั้งค่า) ก่อนเริ่มกระบวนการย้ายข้อมูลในกรณีที่คุณต้องสร้างใหม่ด้วยตนเอง

## กระบวนการย้ายข้อมูล

### ประกาศสำคัญเกี่ยวกับการมองเห็นบอทใน V3

ใน V3 **บอท v2 ทั้งหมดที่เปิดการแชร์สาธารณะจะสามารถค้นหาได้ใน Bot Store** หากคุณมีบอทที่มีข้อมูลที่ละเอียดอ่อนที่คุณไม่ต้องการให้ค้นพบ ให้พิจารณาทำให้เป็นส่วนตัวก่อนย้ายไปยัง V3

### ขั้นตอนที่ 1: ระบุชื่อสภาพแวดล้อมของคุณ

ในขั้นตอนนี้ `{YOUR_ENV_PREFIX}` ระบุชื่อของ CloudFormation Stacks ของคุณ หากคุณใช้คุณลักษณะ [Deploying Multiple Environments](../../README.md#deploying-multiple-environments) ให้แทนที่ด้วยชื่อสภาพแวดล้อมที่จะย้าย หากไม่ใช่ ให้แทนที่ด้วยสตริงว่าง

### ขั้นตอนที่ 2: อัปเดต Repository URL (แนะนำ)

ที่เก็บ repository ได้ถูกเปลี่ยนชื่อจาก `bedrock-claude-chat` เป็น `bedrock-chat` อัปเดต repository ในเครื่องของคุณ:

```bash
# ตรวจสอบ URL ระยะไกลปัจจุบันของคุณ
git remote -v

# อัปเดต URL ระยะไกล
git remote set-url origin https://github.com/aws-samples/bedrock-chat.git

# ตรวจสอบการเปลี่ยนแปลง
git remote -v
```

### ขั้นตอนที่ 3: ตรวจสอบให้แน่ใจว่าอยู่ในเวอร์ชันล่าสุดของ V2

> [!คำเตือน]
> คุณต้องอัปเดตเป็น v2.10.0 ก่อนย้ายไปยัง V3 **การข้ามขั้นตอนนี้อาจทำให้เกิดการสูญเสียข้อมูลระหว่างการย้าย**

ก่อนเริ่มการย้าย ให้ตรวจสอบให้แน่ใจว่าคุณกำลังใช้เวอร์ชันล่าสุดของ V2 (**v2.10.0**) เพื่อให้แน่ใจว่าคุณมีการแก้ไขข้อบกพร่องและการปรับปรุงที่จำเป็นก่อนอัปเกรดเป็น V3:

```bash
# ดึง tags ล่าสุด
git fetch --tags

# สลับไปยังเวอร์ชัน V2 ล่าสุด
git checkout v2.10.0

# ปรับใช้เวอร์ชัน V2 ล่าสุด
cd cdk
npm ci
npx cdk deploy --all
```

### ขั้นตอนที่ 4: บันทึกชื่อตาราง DynamoDB V2 ของคุณ

รับชื่อตาราง ConversationTable V2 จาก CloudFormation outputs:

```bash
# รับชื่อตาราง ConversationTable V2
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableName'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack
```

ตรวจสอบให้แน่ใจว่าบันทึกชื่อตารางนี้ไว้ในตำแหน่งที่ปลอดภัย เนื่องจากคุณจะต้องใช้ในสคริปต์การย้ายข้อมูลในภายหลัง

### ขั้นตอนที่ 5: สำรองตาราง DynamoDB

ก่อนดำเนินการต่อ ให้สร้างสำเนาสำรองของ DynamoDB ConversationTable โดยใช้ชื่อที่คุณเพิ่งบันทึก:

```bash
# สร้างสำเนาสำรองของตารางของคุณ
aws dynamodb create-backup \
  --no-cli-pager \
  --backup-name "BedrockChatV2Backup-$(date +%Y%m%d)" \
  --table-name YOUR_V2_CONVERSATION_TABLE_NAME

# ตรวจสอบสถานะสำเนาสำรองว่าพร้อมใช้งาน
aws dynamodb describe-backup \
  --no-cli-pager \
  --query BackupDescription.BackupDetails \
  --backup-arn YOUR_BACKUP_ARN
```

### ขั้นตอนที่ 6: ลบ API ที่เผยแพร่ทั้งหมด

> [!สำคัญ]
> ก่อนปรับใช้ V3 คุณต้องลบ API ที่เผยแพร่ทั้งหมดเพื่อหลีกเลี่ยงความขัดแย้งของค่า Cloudformation output ระหว่างกระบวนการอัปเกรด

1. เข้าสู่ระบบแอปพลิเคชันของคุณในฐานะผู้ดูแลระบบ
2. ไปที่ส่วนผู้ดูแลระบบและเลือก "การจัดการ API"
3. ตรวจสอบรายการ API ที่เผยแพร่ทั้งหมด
4. ลบ API ที่เผยแพร่แต่ละรายการโดยคลิกปุ่มลบที่อยู่ถัดไป

คุณสามารถค้นหาข้อมูลเพิ่มเติมเกี่ยวกับการเผยแพร่และการจัดการ API ได้ใน [PUBLISH_API.md](../PUBLISH_API_th-TH.md), [ADMINISTRATOR.md](../ADMINISTRATOR_th-TH.md)

### ขั้นตอนที่ 7: ดึง V3 และปรับใช้

ดึงโค้ด V3 ล่าสุดและปรับใช้:

```bash
git fetch
git checkout v3
cd cdk
npm ci
npx cdk deploy --all
```

> [!สำคัญ]
> เมื่อคุณปรับใช้ V3 แอปพลิเคชันจะไม่สามารถใช้งานได้สำหรับผู้ใช้ทั้งหมดจนกว่ากระบวนการย้ายข้อมูลจะเสร็จสมบูรณ์ สคีมาใหม่ไม่เข้ากันกับรูปแบบข้อมูลเก่า ดังนั้นผู้ใช้จะไม่สามารถเข้าถึงบอทหรือการสนทนาของตนได้จนกว่าคุณจะดำเนินการสคริปต์การย้ายข้อมูลในขั้นตอนถัดไป

### ขั้นตอนที่ 8: บันทึกชื่อตาราง DynamoDB V3 ของคุณ

หลังจากปรับใช้ V3 คุณต้องรับชื่อตาราง ConversationTable และ BotTable ใหม่:

```bash
# รับชื่อตาราง ConversationTable V3
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack

# รับชื่อตาราง BotTable V3
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='BotTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack
```

> [!สำคัญ]
> ตรวจสอบให้แน่ใจว่าบันทึกชื่อตาราง V3 เหล่านี้พร้อมกับชื่อตาราง V2 ที่คุณบันทึกไว้ก่อนหน้านี้ เนื่องจากคุณจะต้องใช้ทั้งหมดสำหรับสคริปต์การย้ายข้อมูล

### ขั้นตอนที่ 9: เรียกใช้สคริปต์การย้ายข้อมูล

สคริปต์การย้ายข้อมูลจะแปลงข้อมูล V2 ของคุณเป็นสคีมา V3 ก่อนอื่นให้แก้ไขสคริปต์การย้ายข้อมูล `docs/migration/migrate_v2_v3.py` เพื่อตั้งค่าชื่อตารางและภูมิภาคของคุณ:

```python
# ภูมิภาคที่ตั้ง dynamodb
REGION = "ap-northeast-1" # แทนที่ด้วยภูมิภาคของคุณ

V2_CONVERSATION_TABLE = "BedrockChatStack-DatabaseConversationTableXXXX" # แทนที่ด้วยค่าที่คุณบันทึกในขั้นตอนที่ 4
V3_CONVERSATION_TABLE = "BedrockChatStack-DatabaseConversationTableV3XXXX" # แทนที่ด้วยค่าที่คุณบันทึกในขั้นตอนที่ 8
V3_BOT_TABLE = "BedrockChatStack-DatabaseBotTableV3XXXXX" # แทนที่ด้วยค่าที่คุณบันทึกในขั้นตอนที่ 8
```

จากนั้นเรียกใช้สคริปต์โดยใช้ Poetry จากไดเรกทอรีแบ็กเอนด์:

> [!หมายเหตุ]
> เวอร์ชันข้อกำหนด Python ถูกเปลี่ยนเป็น 3.13.0 หรือใหม่กว่า (อาจมีการเปลี่ยนแปลงในการพัฒนาในอนาคต ดู pyproject.toml) หากคุณติดตั้ง venv ด้วย Python เวอร์ชันที่แตกต่าง คุณจะต้องลบออกครั้งหนึ่ง

```bash
# ไปที่ไดเรกทอรีแบ็กเอนด์
cd backend

# ติดตั้งการพึ่งพาหากคุณยังไม่ได้ทำ
poetry install

# เรียกใช้การทดลองก่อนเพื่อดูว่าจะย้ายอะไรบ้าง
poetry run python ../docs/migration/migrate_v2_v3.py --dry-run

# หากทุกอย่างดูเรียบร้อย ให้เรียกใช้การย้ายข้อมูลจริง
poetry run python ../docs/migration/migrate_v2_v3.py

# ตรวจสอบว่าการย้ายข้อมูลสำเร็จ
poetry run python ../docs/migration/migrate_v2_v3.py --verify-only
```

สคริปต์การย้ายข้อมูลจะสร้างไฟล์รายงานในไดเรกทอรีปัจจุบันของคุณพร้อมรายละเอียดเกี่ยวกับกระบวนการย้ายข้อมูล ตรวจสอบไฟล์นี้เพื่อให้แน่ใจว่าข้อมูลทั้งหมดของคุณถูกย้ายอย่างถูกต้อง

#### การจัดการปริมาณข้อมูลขนาดใหญ่

สำหรับสภาพแวดล้อมที่มีผู้ใช้หนาแน่นหรือมีข้อมูลปริมาณมาก ให้พิจารณาแนวทางเหล่านี้:

1. **ย้ายผู้ใช้แต่ละราย**: สำหรับผู้ใช้ที่มีปริมาณข้อมูลมาก ให้ย้ายทีละคน:

   ```bash
   poetry run python ../docs/migration/migrate_v2_v3.py --users user-id-1 user-id-2
   ```

2. **ข้อควรพิจารณาเรื่องหน่วยความจำ**: กระบวนการย้ายโหลดข้อมูลเข้าหน่วยความจำ หากคุณพบข้อผิดพลาด Out-Of-Memory (OOM) ให้ลอง:

   - ย้ายผู้ใช้ทีละคน
   - เรียกใช้การย้ายข้อมูลบนเครื่องที่มีหน่

## คำถามที่พบบ่อย V3

### การเข้าถึงบอทและสิทธิอนุญาต

**ถาม: เกิดอะไรขึ้นหากบอทที่ฉันใช้ถูกลบหรือสิทธิการเข้าถึงของฉันถูกเอาออก?**
ตอบ: การตรวจสอบสิทธิอนุญาตจะทำในขณะแชท ดังนั้นคุณจะสูญเสียการเข้าถึงทันที

**ถาม: เกิดอะไรขึ้นหากผู้ใช้ถูกลบ (เช่น พนักงานลาออก)?**
ตอบ: ข้อมูลของพวกเขาสามารถถูกลบได้อย่างสมบูรณ์โดยการลบรายการทั้งหมดจาก DynamoDB ด้วย user ID เป็นคีย์พาร์ติชัน (PK)

**ถาม: ฉันสามารถปิดการแชร์สำหรับบอทสาธารณะที่สำคัญได้หรือไม่?**
ตอบ: ไม่ได้ ผู้ดูแลระบบต้องทำเครื่องหมายบอทว่าไม่สำคัญก่อนจึงจะปิดการแชร์ได้

**ถาม: ฉันสามารถลบบอทสาธารณะที่สำคัญได้หรือไม่?**
ตอบ: ไม่ได้ ผู้ดูแลระบบต้องทำเครื่องหมายบอทว่าไม่สำคัญก่อนจึงจะลบได้

### ความปลอดภัยและการใช้งาน

**ถาม: มีการใช้งานความปลอดภัยระดับแถว (RLS) สำหรับตารางบอทหรือไม่?**
ตอบ: ไม่มี เนื่องจากรูปแบบการเข้าถึงที่หลากหลาย การตรวจสอบสิทธิอนุญาตจะทำเมื่อเข้าถึงบอท และความเสี่ยงของการรั่วไหลข้อมูลเมตาถือว่าน้อยเมื่อเทียบกับประวัติการสนทนา

**ถาม: มีข้อกำหนดอะไรบ้างสำหรับการเผยแพร่ API?**
ตอบ: บอทต้องเป็นสาธารณะ

**ถาม: จะมีหน้าจัดการสำหรับบอทส่วนตัวทั้งหมดหรือไม่?**
ตอบ: ไม่มีในการเผยแพร่ V3 เริ่มแรก อย่างไรก็ตาม สามารถลบรายการได้โดยการค้นหาด้วย user ID ตามความจำเป็น

**ถาม: จะมีฟังก์ชันการติดแท็กบอทเพื่อปรับปรุงประสบการณ์การค้นหาหรือไม่?**
ตอบ: ไม่มีในการเผยแพร่ V3 เริ่มแรก แต่อาจเพิ่มการติดแท็กอัตโนมัติด้วย LLM ในการอัปเดตในอนาคต

### การดูแลระบบ

**ถาม: ผู้ดูแลระบบสามารถทำอะไรได้บ้าง?**
ตอบ: ผู้ดูแลระบบสามารถ:

- จัดการบอทสาธารณะ (รวมถึงการตรวจสอบบอทที่มีต้นทุนสูง)
- จัดการ API
- ทำเครื่องหมายบอทสาธารณะเป็นสำคัญ

**ถาม: ฉันสามารถทำบอทที่แชร์บางส่วนเป็นสำคัญได้หรือไม่?**
ตอบ: ไม่ได้ รองรับเฉพาะบอทสาธารณะเท่านั้น

**ถาม: ฉันสามารถตั้งลำดับความสำคัญสำหรับบอทที่ปักหมุดได้หรือไม่?**
ตอบ: ในการเผยแพร่เริ่มแรก ไม่สามารถทำได้

### การกำหนดค่าสิทธิอนุญาต

**ถาม: ฉันจะตั้งค่าสิทธิอนุญาตอย่างไร?**
ตอบ:

1. เปิดคอนโซล Amazon Cognito และสร้างกลุ่มผู้ใช้ใน BrChat user pool
2. เพิ่มผู้ใช้เข้าสู่กลุ่มตามความจำเป็น
3. ใน BrChat เลือกกลุ่มผู้ใช้ที่คุณต้องการอนุญาตการเข้าถึงเมื่อกำหนดค่าการแชร์บอท

หมายเหตุ: การเปลี่ยนแปลงสมาชิกกลุ่มต้องการการเข้าสู่ระบบใหม่เพื่อมีผล การเปลี่ยนแปลงจะสะท้อนในการรีเฟรชโทเคน แต่ไม่ในระหว่างระยะเวลาความถูกต้องของ ID โทเคน (ค่าเริ่มต้น 30 นาทีใน V3 สามารถกำหนดค่าได้โดย `tokenValidMinutes` ใน `cdk.json` หรือ `parameter.ts`)

**ถาม: ระบบตรวจสอบกับ Cognito ทุกครั้งที่เข้าถึงบอทหรือไม่?**
ตอบ: ไม่ การตรวจสอบสิทธิอนุญาตจะใช้ JWT โทเคนเพื่อหลีกเลี่ยงการดำเนินการ I/O ที่ไม่จำเป็น

### ฟังก์ชันการค้นหา

**ถาม: การค้นหาบอทรองรับการค้นหาเชิงความหมายหรือไม่?**
ตอบ: ไม่ รองรับเพียงการจับคู่ข้อความบางส่วนเท่านั้น การค้นหาเชิงความหมาย (เช่น "automobile" → "car", "EV", "vehicle") ไม่สามารถใช้งานได้เนื่องจากข้อจำกัดของ OpenSearch Serverless ในปัจจุบัน (มี.ค. 2025)