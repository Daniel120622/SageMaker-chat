# マイグレーションガイド (v1 から v2)

## TL;DR

- **v1.2 以前のユーザー向け**: v1.4 にアップグレードし、ナレッジベース（KB）を使用してボットを再作成してください。移行期間後、KB で期待通りに動作することを確認したら、v2 にアップグレードしてください。
- **v1.3 のユーザー向け**: すでに KB を使用している場合でも、v1.4 にアップグレードしてボットを再作成することを**強く推奨**します。pgvector を使用している場合は、v1.4 の KB を使用してボットを再作成することで移行してください。
- **pgvector の継続使用を希望するユーザー向け**: pgvector の使用を継続する予定の場合、v2 へのアップグレードは推奨されません。v2 にアップグレードすると pgvector に関連するすべてのリソースが削除され、今後のサポートは利用できなくなります。この場合は v1 を継続使用してください。
- **v2 へのアップグレードにより、Aurora 関連のすべてのリソースが削除されることに注意してください。**今後の更新は v2 に集中し、v1 は廃止されます。

## はじめに

### 何が起こるか

v2 アップデートでは、Aurora Serverless と ECS ベースの埋め込みで使用されていた pgvector を[Amazon Bedrock ナレッジベース](https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base.html)に置き換えるという大きな変更が導入されます。この変更は後方互換性がありません。

### なぜこのリポジトリがナレッジベースを採用し、pgvector を中止したのか

この変更には、いくつかの理由があります：

#### RAG の精度向上

- ナレッジベースはバックエンドに OpenSearch Serverless を使用し、フルテキストとベクター検索の両方によるハイブリッド検索を可能にします。これにより、固有名詞を含む質問に対する応答の精度が向上し、pgvector が苦手としていた部分を改善します。
- また、高度なチャンキングや解析など、RAG の精度を向上させるためのより多くのオプションをサポートしています。
- ナレッジベースは 2024 年 10 月時点で一般提供開始からほぼ 1 年が経過し、ウェブクローリングなどの機能がすでに追加されています。将来的な更新が予想され、長期的に高度な機能を採用しやすくなっています。例えば、このリポジトリでは pgvector で既存の S3 バケットからのインポート（頻繁にリクエストされていた機能）を実装していませんでしたが、ナレッジベース（KB）ではすでにサポートされています。

#### メンテナンス

- 現在の ECS + Aurora の設定は、PDF パース、ウェブクローリング、YouTube トランスクリプト抽出などの多数のライブラリに依存しています。対照的に、ナレッジベースのようなマネージドソリューションは、ユーザーとリポジトリの開発チームの両方にとってメンテナンスの負担を軽減します。

## 移行プロセス（概要）

v1.4 にアップグレードしてから、v2 に移行することを強くお勧めします。v1.4 では、pgvector とナレッジベースボットの両方を使用できるため、既存の pgvector ボットをナレッジベースに再作成し、期待通りに動作することを確認する移行期間を設けることができます。RAG ドキュメントが同一であっても、OpenSearch のバックエンド変更により、k-NN アルゴリズムなどの違いにより、結果がわずかに異なる可能性があることに注意してください。ただし、通常は非常に類似した結果になります。

`cdk.json`で`useBedrockKnowledgeBasesForRag`を`true`に設定することで、ナレッジベースを使用したボットを作成できます。ただし、pgvector ボットは読み取り専用になり、新しい pgvector ボットの作成や編集ができなくなります。

![](../imgs/v1_to_v2_readonly_bot.png)

v1.4 では、[Amazon Bedrock 用ガードレール](https://aws.amazon.com/jp/bedrock/guardrails/)も導入されています。ナレッジベースの地域制限により、ドキュメントをアップロードする S3 バケットは、`bedrockRegion`と同じリージョンにある必要があります。更新前に既存のドキュメントバケットをバックアップすることをお勧めします。これにより、後で大量のドキュメントを手動でアップロードする必要がなくなります（S3 バケットのインポート機能が利用可能です）。

## マイグレーションプロセス（詳細）

使用しているバージョンが v1.2 以前か v1.3 かによって、手順が異なります。

![](../imgs/v1_to_v2_arch.png)

### v1.2 以前のユーザー向けの手順

1. **既存のドキュメントバケットをバックアップする（オプションだが推奨）。** システムが既に運用されている場合、この手順を強くお勧めします。`bedrockchatstack-documentbucketxxxx-yyyy` という名前のバケットをバックアップします。例えば、[AWS バックアップ](https://docs.aws.amazon.com/aws-backup/latest/devguide/s3-backups.html)を使用できます。

2. **v1.4 に更新**: 最新の v1.4 タグを取得し、`cdk.json` を変更し、デプロイします。以下の手順に従ってください：

   1. 最新のタグを取得：
      ```bash
      git fetch --tags
      git checkout tags/v1.4.0
      ```
   2. `cdk.json` を以下のように変更：
      ```json
      {
        ...,
        "useBedrockKnowledgeBasesForRag": true,
        ...
      }
      ```
   3. 変更をデプロイ：
      ```bash
      npx cdk deploy
      ```

3. **ボットの再作成**: Knowledge Base で、pgvector ボットと同じ定義（ドキュメント、チャンクサイズなど）でボットを再作成します。ドキュメントの量が多い場合、ステップ 1 のバックアップから復元すると、このプロセスが容易になります。復元するには、クロスリージョンコピーの復元を使用できます。詳細は[こちら](https://docs.aws.amazon.com/aws-backup/latest/devguide/restoring-s3.html)を参照してください。復元したバケットを指定するには、`S3 データソース`セクションを以下のように設定します。パス構造は `s3://<bucket-name>/<user-id>/<bot-id>/documents/` です。ユーザー ID は Cognito ユーザープールで、ボット ID はボット作成画面のアドレスバーで確認できます。

![](../imgs/v1_to_v2_KB_s3_source.png)

**Knowledge Base ではウェブクローリングや YouTube トランスクリプトのサポートなど、一部の機能が利用できないことに注意してください（ウェブクローラーのサポートを計画中 ([issue](https://github.com/aws-samples/bedrock-chat/issues/557)))）。また、移行中は Aurora と Knowledge Base の両方の料金が発生することに注意してください。**

4. **公開済み API の削除**: VPC の削除により、以前に公開されたすべての API は、v2 をデプロイする前に再公開する必要があります。そのためには、まず既存の API を削除する必要があります。[管理者の API 管理機能](../ADMINISTRATOR_ja-JP.md)を使用すると、このプロセスを簡略化できます。すべての `APIPublishmentStackXXXX` CloudFormation スタックの削除が完了したら、環境の準備が整います。

5. **v2 のデプロイ**: v2 のリリース後、タグ付けされたソースを取得し、以下のようにデプロイします（リリース後に可能になります）：
   ```bash
   git fetch --tags
   git checkout tags/v2.0.0
   npx cdk deploy
   ```

> [!警告]
> v2 をデプロイすると、**[サポート対象外、読み取り専用]プレフィックスのあるすべてのボットが非表示になります。** アップグレード前に必要なボットを再作成し、アクセスの喪失を防いでください。

> [!ヒント]
> スタックの更新中、「リソースハンドラーがメッセージを返しました：「サブネット 'subnet-xxx' には依存関係があり、削除できません。」のような繰り返しメッセージが表示されることがあります。そのような場合は、マネジメントコンソール > EC2 > ネットワークインターフェースに移動し、BedrockChatStack を検索します。表示されたインターフェースを削除して、デプロイプロセスをスムーズにします。

### v1.3 ユーザー向けの手順

前述の通り、v1.4 では、リージョンの制限により、Knowledge Base は bedrockRegion で作成する必要があります。そのため、Knowledge Base を再作成する必要があります。v1.3 で既に Knowledge Base をテストしている場合は、v1.4 で同じ定義のボットを再作成してください。v1.2 ユーザー向けの手順に従ってください。
