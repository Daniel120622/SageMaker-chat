# マイグレーションガイド（v2からv3へ）

## TL;DR

- V3では、きめ細かい権限制御とBot Store機能が導入され、DynamoDBスキーマの変更が必要になります
- **移行前に、DynamoDBの会話テーブルをバックアップしてください**
- リポジトリのURLを`bedrock-claude-chat`から`bedrock-chat`に更新してください
- 移行スクリプトを実行して、データを新しいスキーマに変換してください
- すべてのボットと会話は、新しい権限モデルで保持されます
- **重要：移行プロセス中、移行が完了するまでアプリケーションはすべてのユーザーに対して利用できなくなります。このプロセスは、データ量と開発環境のパフォーマンスに応じて、通常約60分かかります。**
- **重要：移行プロセス中に、すべての公開済みAPIを削除する必要があります。**
- **警告：移行プロセスは、すべてのボットで100%の成功を保証できません。重要なボット設定は、手動で再作成する必要がある場合に備えて、移行前に必ず文書化してください。**

## はじめに

### V3の新機能

V3では、Bedrock Chatに以下の重要な機能強化が導入されました：

1. **きめ細かい権限制御**：ユーザーグループベースの権限で、ボットへのアクセスを制御
2. **ボットストア**：集中型マーケットプレイスでボットを共有および発見
3. **管理機能**：APIの管理、ボットを重要としてマーク、ボットの使用状況の分析

これらの新機能には、DynamoDBスキーマへの変更が必要となり、既存のユーザーには移行プロセスが求められます。

### この移行が必要な理由

新しい権限モデルとボットストアの機能には、ボットデータの保存と取得方法の再構築が必要でした。移行プロセスは、既存のボットと会話を新しいスキーマに変換し、すべてのデータを保持します。

> [!WARNING]
> サービス中断のお知らせ：**移行プロセス中は、すべてのユーザーにアプリケーションを利用できません。** メンテナンス時間帯に、ユーザーがシステムにアクセスする必要がない時に、この移行を実施してください。移行スクリプトが正常に完了し、すべてのデータが新しいスキーマに正しく変換された後にのみ、アプリケーションが再び利用可能になります。このプロセスは、データ量と開発環境のパフォーマンスによって、通常約60分かかります。

> [!IMPORTANT]
> 移行を進める前に：**移行プロセスは、すべてのボット（特に古いバージョンで作成されたボットやカスタム設定のあるボット）で100%の成功を保証できません。**移行プロセスを開始する前に、重要なボット設定（指示、ナレッジソース、設定）を文書化し、手動で再作成する必要がある場合に備えてください。

## 移行プロセス

### V3におけるボットの可視性に関する重要な注意事項

V3では、**公開共有が有効なすべてのV2ボットがBot Storeで検索可能になります。** 公開したくない機密情報を含むボットがある場合は、V3に移行する前に非公開にすることをご検討ください。

### ステップ1: 環境名の特定

この手順では、`{YOUR_ENV_PREFIX}`はCloudFormationスタックの名前を識別するために指定されます。[複数環境のデプロイ](../../README.md#deploying-multiple-environments)機能を使用している場合は、移行する環境の名前に置き換えてください。使用していない場合は、空の文字列に置き換えてください。

### ステップ2: リポジトリURLの更新（推奨）

リポジトリが`bedrock-claude-chat`から`bedrock-chat`に名称変更されました。ローカルリポジトリを更新してください：

```bash
# 現在のリモートURLを確認
git remote -v

# リモートURLを更新
git remote set-url origin https://github.com/aws-samples/bedrock-chat.git

# 変更を確認
git remote -v
```

### ステップ3: 最新のV2バージョンであることを確認

> [!WARNING]
> V3に移行する前に、v2.10.0に更新する必要があります。**このステップをスキップすると、移行中にデータ損失が発生する可能性があります。**

移行を開始する前に、V2の最新バージョン（**v2.10.0**）を実行していることを確認してください：

```bash
# 最新のタグを取得
git fetch --tags

# 最新のV2バージョンをチェックアウト
git checkout v2.10.0

# 最新のV2バージョンをデプロイ
cd cdk
npm ci
npx cdk deploy --all
```

### ステップ4: V2 DynamoDBテーブル名の記録

CloudFormationの出力からV2 ConversationTableの名前を取得：

```bash
# V2 ConversationTableの名前を取得
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableName'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack
```

後で移行スクリプトで使用するため、このテーブル名を安全な場所に保存してください。

### ステップ5: DynamoDBテーブルのバックアップ

続行する前に、先ほど記録したテーブル名を使用して、DynamoDB ConversationTableのバックアップを作成してください：

```bash
# V2テーブルのバックアップを作成
aws dynamodb create-backup \
  --no-cli-pager \
  --backup-name "BedrockChatV2Backup-$(date +%Y%m%d)" \
  --table-name YOUR_V2_CONVERSATION_TABLE_NAME

# バックアップステータスが利用可能であることを確認
aws dynamodb describe-backup \
  --no-cli-pager \
  --query BackupDescription.BackupDetails \
  --backup-arn YOUR_BACKUP_ARN
```

### ステップ6: 公開されているすべてのAPIを削除

> [!IMPORTANT]
> V3をデプロイする前に、アップグレードプロセス中のCloudFormationの出力値の競合を避けるため、公開されているすべてのAPIを削除する必要があります。

1. 管理者としてアプリケーションにログイン
2. 管理セクションに移動し、「API管理」を選択
3. 公開されているすべてのAPIのリストを確認
4. 各公開APIの横にある削除ボタンをクリックして削除

APIの公開と管理の詳細については、[PUBLISH_API.md](../PUBLISH_API_ja-JP.md)、[ADMINISTRATOR.md](../ADMINISTRATOR_ja-JP.md)のドキュメンテーションを参照してください。

### ステップ7：V3をプルしてデプロイ

最新のV3コードをプルしてデプロイ：

```bash
git fetch
git checkout v3
cd cdk
npm ci
npx cdk deploy --all
```

> [!IMPORTANT]
> V3をデプロイすると、移行プロセスが完了するまで、すべてのユーザーがアプリケーションを使用できなくなります。新しいスキーマは古いデータ形式と互換性がないため、次のステップの移行スクリプトを完了するまで、ユーザーはボットや会話にアクセスできません。

### ステップ8：V3 DynamoDBテーブル名の記録

V3をデプロイした後、新しいConversationTableとBotTableの両方の名前を取得する必要があります：

```bash
# V3 ConversationTableの名前を取得
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack

# V3 BotTableの名前を取得
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='BotTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack
```

> [!Important]
> 移行スクリプトで必要になるため、これらのV3テーブル名を、以前に保存したV2テーブル名と一緒に必ず保存してください。

### ステップ9：移行スクリプトの実行

移行スクリプトは、V2データをV3スキーマに変換します。まず、移行スクリプト`docs/migration/migrate_v2_v3.py`を編集してテーブル名とリージョンを設定します：

```python
# DynamoDBが配置されているリージョン
REGION = "ap-northeast-1" # お使いのリージョンに置き換えてください

V2_CONVERSATION_TABLE = "BedrockChatStack-DatabaseConversationTableXXXX" # ステップ4で記録した値に置き換えてください
V3_CONVERSATION_TABLE = "BedrockChatStack-DatabaseConversationTableV3XXXX" # ステップ8で記録した値に置き換えてください
V3_BOT_TABLE = "BedrockChatStack-DatabaseBotTableV3XXXXX" # ステップ8で記録した値に置き換えてください
```

その後、バックエンドディレクトリからPoetryを使用してスクリプトを実行します：

> [!NOTE]
> Pythonの要件バージョンが3.13.0以降に変更されました（将来の開発で変更される可能性があります。pyproject.tomlを参照）。異なるPythonバージョンでvenvがインストールされている場合、一度削除する必要があります。

```bash
# バックエンドディレクトリに移動
cd backend

# まだ依存関係をインストールしていない場合
poetry install

# 最初にドライラン（何が移行されるかを確認）
poetry run python ../docs/migration/migrate_v2_v3.py --dry-run

# すべてが問題なければ、実際の移行を実行
poetry run python ../docs/migration/migrate_v2_v3.py

# 移行が成功したことを確認
poetry run python ../docs/migration/migrate_v2_v3.py --verify-only
```

移行スクリプトは、現在のディレクトリに移行プロセスの詳細を記載したレポートファイルを生成します。すべてのデータが正しく移行されたことを確認するため、このファイルを確認してください。

#### 大量のデータを扱う場合の対処

ヘビーユーザーや大量のデータを持つ環境の場合、以下のアプローチを検討してください：

1. **ユーザーごとに移行**: 大量のデータを持つユーザーの場合、一度に1人ずつ移行：

   ```bash
   poetry run python ../docs/migration/migrate_v2_v3.py --users user-id-1 user-id-2
   ```

2. **メモリに関する注意点**: 移行プロセスはデータをメモリにロードします。メモリ不足（OOM）エラーが発生した場合は、以下を試してください：

   - ユーザーを一度に1人ずつ移行
   - より多くのメモリを持つマシンで移行を実行
   - ユーザーのバッチを分割して移行

3. **移行の監視**: 特に大規模なデータセットの場合、生成されたレポートファイルを確認し、すべてのデータが正しく移行されていることを確認してください。

### ステップ10：アプリケーションの確認

移行後、アプリケーションを開いて以下を確認してください：

- すべてのボットが利用可能であること
- 会話が保持されていること
- 新しい権限制御が機能していること

### クリーンアップ（オプション）

移行が成功し、V3ですべてのデータが正しくアクセス可能であることを確認した後、コストを節約するためにV2会話テーブルを任意で削除できます：

```bash
# V2会話テーブルを削除（移行が成功したことを確認した後のみ）
aws dynamodb delete-table --table-name YOUR_V2_CONVERSATION_TABLE_NAME
```

> [!IMPORTANT]
> 重要なデータがすべてV3に正常に移行されたことを徹底的に確認した後にのみ、V2テーブルを削除してください。移行後数週間は、元のテーブルを削除した場合でも、ステップ2で作成したバックアップを保持することをお勧めします。

## V3 よくある質問

### ボットアクセスと権限

**Q: 使用しているボットが削除されたり、アクセス権限が削除された場合はどうなりますか？**
A: 認証はチャット時にチェックされるため、即座にアクセスできなくなります。

**Q: ユーザーが削除された場合（例：従業員の退職）はどうなりますか？**
A: ユーザーIDをパーティションキー（PK）としてDynamoDBからすべてのアイテムを削除することで、そのデータを完全に削除できます。

**Q: 重要な公開ボットの共有を無効にできますか？**
A: いいえ、管理者が最初にボットを重要でないとマークしてから、共有を無効にする必要があります。

**Q: 重要な公開ボットを削除できますか？**
A: いいえ、管理者が最初にボットを重要でないとマークしてから、削除する必要があります。

### セキュリティと実装

**Q: ボットテーブルにロウレベルセキュリティ（RLS）は実装されていますか？**
A: いいえ、アクセスパターンの多様性を考慮して実装されていません。ボットにアクセスする際に認証が行われ、会話履歴と比較してメタデータの漏洩リスクは最小限と考えられています。

**Q: APIを公開するための要件は何ですか？**
A: ボットは公開されている必要があります。

**Q: すべてのプライベートボットの管理画面はありますか？**
A: 初期のV3リリースではありません。ただし、必要に応じてユーザーIDでクエリを実行してアイテムを削除することは可能です。

**Q: より良い検索UXのためのボットタグ付け機能はありますか？**
A: 初期のV3リリースではありませんが、将来的にLLMベースの自動タグ付けが追加される可能性があります。

### 管理

**Q: 管理者は何ができますか？**
A: 管理者は以下のことができます：

- 公開ボットの管理（高コストボットのチェックを含む）
- APIの管理
- 公開ボットを重要としてマーク

**Q: 部分的に共有されているボットを重要としてマークできますか？**
A: いいえ、公開ボットのみサポートしています。

**Q: ピン留めされたボットの優先順位を設定できますか？**
A: 初期リリースでは、できません。

### 認証設定

**Q: 認証はどのように設定しますか？**
A:

1. Amazon Cognito コンソールを開き、BrChatユーザープールでユーザーグループを作成
2. 必要に応じてユーザーをグループに追加
3. BrChatで、ボットの共有設定を構成する際に、アクセスを許可するユーザーグループを選択

注意：グループメンバーシップの変更には再ログインが必要です。変更はトークンの更新時に反映されますが、IDトークンの有効期間中（V3でデフォルト30分、`cdk.json`または`parameter.ts`の`tokenValidMinutes`で設定可能）は反映されません。

**Q: システムはボットにアクセスするたびにCognitoで確認しますか？**
A: いいえ、不要な I/O 操作を避けるため、JWTトークンを使用して認証がチェックされます。

### 検索機能

**Q: ボット検索はセマンティック検索をサポートしていますか？**
A: いいえ、部分的なテキスト一致のみをサポートしています。セマンティック検索（例：「automobile」→「car」、「EV」、「vehicle」）は、現在のOpenSearch Serverlessの制約（2025年3月時点）により利用できません。