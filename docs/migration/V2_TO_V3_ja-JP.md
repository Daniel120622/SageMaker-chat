# マイグレーションガイド（v2からv3へ）

## TL;DR

- V3では、細かい権限制御とBot Storeの機能が導入され、DynamoDBスキーマの変更が必要になります
- **移行前に、DynamoDBの会話テーブルをバックアップしてください**
- リポジトリのURLを`bedrock-claude-chat`から`bedrock-chat`に更新してください
- 移行スクリプトを実行して、データを新しいスキーマに変換してください
- すべてのボットと会話は、新しい権限モデルで保持されます
- **重要：移行プロセス中は、移行が完了するまでアプリケーションはすべてのユーザーに対して利用できなくなります。このプロセスは、データ量と開発環境のパフォーマンスによって、通常約60分かかります。**
- **重要：移行プロセス中に、すべての公開APIを削除する必要があります。**
- **警告：移行プロセスは、すべてのボットで100%の成功を保証できません。重要なボット設定は、手動で再作成する必要がある場合に備えて、移行前に必ずドキュメント化してください。**

## はじめに

### V3の新機能

V3では、Bedrock Chatに重要な機能強化が導入されました：

1. **きめ細かな権限制御**: ユーザーグループベースの権限で、ボットへのアクセスを制御
2. **ボットストア**: 一元化されたマーケットプレイスでボットを共有および発見
3. **管理機能**: APIの管理、ボットを重要としてマーク、ボットの利用状況分析

これらの新機能には、DynamoDBスキーマの変更が必要となり、既存ユーザーに対して移行プロセスが求められます。

### この移行が必要な理由

新しい権限モデルとボットストアの機能には、ボットデータの保存および取得方法の再構築が必要でした。移行プロセスでは、既存のボットと会話を新しいスキーマに変換し、すべてのデータを保持します。

> [!WARNING]
> サービス中断のお知らせ: **移行プロセス中、アプリケーションはすべてのユーザーに対して利用できなくなります。** メンテナンス時間帯に、ユーザーがシステムにアクセスする必要がない時に、この移行を実行してください。移行スクリプトが正常に完了し、すべてのデータが新しいスキーマに適切に変換された後にのみ、アプリケーションが再び利用可能になります。このプロセスは、データ量と開発環境のパフォーマンスに応じて、通常約60分かかります。

> [!IMPORTANT]
> 移行を進める前に: **移行プロセスは、すべてのボットに対して100%の成功を保証できません**。特に古いバージョンで作成されたボットや、カスタム設定のあるボットは注意が必要です。移行プロセスを開始する前に、重要なボット設定（命令、知識ソース、設定）を文書化し、手動で再作成する必要がある場合に備えてください。

## 移行プロセス

### V3におけるボットの可視性に関する重要な注意事項

V3では、**公開共有が有効なすべてのV2ボットがBot Storeで検索可能になります。** 機密情報を含むボットを公開したくない場合は、V3に移行する前にプライベートに設定することをお勧めします。

### ステップ1：環境名の特定

この手順では、`{YOUR_ENV_PREFIX}`はCloudFormationスタックの名前を識別するために指定されます。[複数環境のデプロイ](../../README.md#deploying-multiple-environments)機能を使用している場合は、移行する環境の名前に置き換えてください。使用していない場合は、空の文字列に置き換えてください。

### ステップ2：リポジトリURLの更新（推奨）

リポジトリが`bedrock-claude-chat`から`bedrock-chat`に名前変更されました。ローカルリポジトリを更新します：

```bash
# 現在のリモートURLを確認
git remote -v

# リモートURLを更新
git remote set-url origin https://github.com/aws-samples/bedrock-chat.git

# 変更を確認
git remote -v
```

### ステップ3：最新のV2バージョンであることを確認

> [!WARNING]
> V3に移行する前に、必ずv2.10.0に更新する必要があります。**このステップをスキップすると、移行中にデータ損失が発生する可能性があります。**

移行を開始する前に、V2の最新バージョン（**v2.10.0**）を実行していることを確認してください：

```bash
# 最新のタグを取得
git fetch --tags

# 最新のV2バージョンをチェックアウト
git checkout v2.10.0

# 最新のV2バージョンをデプロイ
cd cdk
npm ci
npx cdk deploy --all
```

### ステップ4：V2 DynamoDBテーブル名の記録

CloudFormationの出力からV2 ConversationTableの名前を取得します：

```bash
# V2 ConversationTableの名前を取得
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableName'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack
```

次のステップで必要になるので、このテーブル名を安全な場所に保存してください。

### ステップ5：DynamoDBテーブルのバックアップ

続行する前に、先ほど記録したテーブル名を使用して、DynamoDB ConversationTableのバックアップを作成します：

```bash
# V2テーブルのバックアップを作成
aws dynamodb create-backup \
  --no-cli-pager \
  --backup-name "BedrockChatV2Backup-$(date +%Y%m%d)" \
  --table-name YOUR_V2_CONVERSATION_TABLE_NAME

# バックアップステータスが利用可能であることを確認
aws dynamodb describe-backup \
  --no-cli-pager \
  --query BackupDescription.BackupDetails \
  --backup-arn YOUR_BACKUP_ARN
```

### ステップ6：すべての公開APIの削除

> [!IMPORTANT]
> V3をデプロイする前に、アップグレードプロセス中のCloudFormation出力値の競合を避けるため、すべての公開APIを削除する必要があります。

1. 管理者としてアプリケーションにログインします
2. 管理セクションに移動し、「API管理」を選択します
3. 公開されているすべてのAPIのリストを確認します
4. 各公開APIの横にある削除ボタンをクリックして削除します

APIの公開と管理の詳細については、[PUBLISH_API.md](../PUBLISH_API_ja-JP.md)、[ADMINISTRATOR.md](../ADMINISTRATOR_ja-JP.md)のドキュメントを参照してください。

### ステップ7：V3をプルしてデプロイ

最新のV3コードをプルしてデプロイします：

```bash
git fetch
git checkout v3
cd cdk
npm ci
npx cdk deploy --all
```

> [!IMPORTANT]
> V3をデプロイすると、移行プロセスが完了するまで、すべてのユーザーがアプリケーションを使用できなくなります。新しいスキーマは古いデータ形式と互換性がないため、次のステップで移行スクリプトを完了するまで、ユーザーはボットや会話にアクセスできません。

### ステップ8：V3 DynamoDBテーブル名の記録

V3をデプロイした後、新しいConversationTableとBotTableの名前の両方を取得する必要があります：

```bash
# V3 ConversationTableの名前を取得
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack

# V3 BotTableの名前を取得
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='BotTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockChatStack
```

> [!Important]
> 移行スクリプトで必要になるので、これらのV3テーブル名を、以前に保存したV2テーブル名と一緒に必ず保存してください。

（以降の部分も同様に翻訳します）

## V3 FAQ

### ボットアクセスと権限

**Q: 使用しているボットが削除されたり、アクセス権限が削除された場合はどうなりますか?**
A: 認証はチャット時に確認されるため、即座にアクセスできなくなります。

**Q: ユーザーが削除された場合（例：従業員の退職）はどうなりますか?**
A: ユーザーIDをパーティションキー（PK）として、DynamoDBからすべてのアイテムを削除することで、そのデータを完全に削除できます。

**Q: 重要な公開ボットの共有を無効にできますか?**
A: いいえ、管理者が最初にボットを重要でないとマークしてから、共有を無効にする必要があります。

**Q: 重要な公開ボットを削除できますか?**
A: いいえ、管理者が最初にボットを重要でないとマークしてから、削除する必要があります。

### セキュリティと実装

**Q: ボットテーブルに行レベルセキュリティ（RLS）は実装されていますか?**
A: いいえ、アクセスパターンの多様性を考慮し、実装されていません。ボットへのアクセス時に認証が行われ、会話履歴と比較してメタデータの漏洩リスクは最小限と考えられています。

**Q: APIを公開するための要件は何ですか?**
A: ボットは公開されている必要があります。

**Q: すべてのプライベートボットの管理画面はありますか?**
A: 初期のV3リリースではありません。ただし、必要に応じてユーザーIDでクエリを実行してアイテムを削除することは可能です。

**Q: 検索UXを改善するためのボットタグ付け機能はありますか?**
A: 初期のV3リリースではありませんが、将来的にLLMベースの自動タグ付けが追加される可能性があります。

### 管理

**Q: 管理者は何ができますか?**
A: 管理者は以下のことができます：

- 公開ボットの管理（高コストボットのチェックを含む）
- APIの管理
- 公開ボットを重要としてマーク

**Q: 部分的に共有されているボットを重要としてマークできますか?**
A: いいえ、公開ボットのみをサポートしています。

**Q: ピン留めされたボットの優先順位を設定できますか?**
A: 初期リリースでは、できません。

### 認証設定

**Q: 認証をどのように設定しますか?**
A:

1. Amazon Cognitoコンソールを開き、BrChatユーザープールにユーザーグループを作成
2. 必要に応じてユーザーをグループに追加
3. BrChatで、ボットの共有設定を構成する際に、アクセスを許可するユーザーグループを選択

注意: グループメンバーシップの変更には再ログインが必要です。変更はトークンの更新時に反映されますが、IDトークンの有効期間中（V3のデフォルトは30分、`cdk.json`または`parameter.ts`の`tokenValidMinutes`で設定可能）は反映されません。

**Q: システムはボットにアクセスするたびにCognitoで確認しますか?**
A: いいえ、不要なI/O操作を避けるため、JWTトークンを使用して認証が確認されます。

### 検索機能

**Q: ボット検索はセマンティック検索をサポートしていますか?**
A: いいえ、部分的なテキスト一致のみをサポートしています。セマンティック検索（例：「automobile」→「car」、「EV」、「vehicle」）は、現在のOpenSearch Serverlessの制約（2025年3月時点）により利用できません。